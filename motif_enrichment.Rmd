---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, options(readr.show_col_types = FALSE))
```

*CONTINUE HERE*
- redo stats with endia_matched_w_all_visits ( metadata 1:1 ratio for nests, possible remake this filw with all samples except onset only
- combine metadata with virscan to create endia_virscan_onse_1to1

```{r}
library(tidyverse)
source("scripts/read_blast.R")
library(glmmTMB)
```

```{r}
endia_samples <- read_csv("raw_data/metadata/identify_plasma_samples.csv") %>% 
  mutate(participant_id = str_replace_all(structured_participant_id, "-", "_"), .keep = "unused") 
         
endia_metadata <- readxl::read_xlsx("raw_data/metadata/finalweights_teddy_plasma_with_visits_deidentified_confounders.xlsx") %>% 
  right_join(endia_samples, by = join_by(mother_id, infant_id)) %>% 
  relocate(participant_id) %>% 
  mutate(recorded_visit = str_replace(recorded_visit, "(?<=[BVT])0", ""), # replace 0 preceded by B, V or T
         condition = ifelse(case == 1, "Case", "Control")) %>% 
  unite(sample_id, c(participant_id, recorded_visit), sep = "_", remove = FALSE) %>% 
 distinct(sample_id, .keep_all = TRUE) # remove duplicate sample IDs from the NCC methodology
```

```{r}
endia_metadata %>% 
  distinct(participant_id, .keep_all = TRUE) %>% 
  group_by(deidentified_nest_id_new) %>%
  summarise(
    cases = sum(condition == "Case"),
    controls = sum(condition == "Control")) %>% 
    mutate(case_control_ratio = paste(cases, controls, sep = ":")) %>% 
   count(case_control_ratio, name = "number of nests")
```

Use data prepared in `01_figure_01_CXVB_antigen_mapping.Rmd`

```{r}
endia_virscan_onset <- read_rds("cache/endia_virscan_metadata.rds") %>%
  filter(onset_visit == 1) %>% 
  group_by(sample_id) %>% 
  mutate(rpk = abundance / sum(abundance) * 100000) %>% 
  mutate(log_lib = log(sum(abundance) + 1e-8)) %>% # add offset for testing 
  ungroup()

vigr_virscan_metadata <- read_rds("cache/vigr_virscan_metadata.rds") %>% 
  group_by(sample_id) %>% 
  mutate(rpk = abundance / sum(abundance) * 100000) %>% 
  ungroup()
```

```bash
makeblastdb -in raw_data/conserved_ev_motifs.fasta -dbtype prot -out raw_data/blast_databases/conserved_ev_motifs_db

blastp -task blastp-short -query cache/endia_virscan_hits_peptides.fasta -db raw_data/blast_databases/conserved_ev_motifs_db -outfmt '6 qaccver saccver pident nident length evalue bitscore mismatch gapopen qstart qend sstart send qseq sseq ppos stitle frames' -evalue 0.01 -word_size 2 -out raw_data/blast_results/blastp_endia_ev_motifs.blast

blastp -task blastp-short -query cache/vigr_virscan_hits_peptides.fasta -db raw_data/blast_databases/conserved_ev_motifs_db -outfmt '6 qaccver saccver pident nident length evalue bitscore mismatch gapopen qstart qend sstart send qseq sseq ppos stitle frames' -evalue 0.01 -word_size 2 -out raw_data/blast_results/blastp_vigr_ev_motifs.blast
```

```{r}
endia_blastp_ev_motifs <- read_blast("raw_data/blast_results/blastp_endia_ev_motifs.blast")

vigr_blastp_ev_motifs <- read_blast("raw_data/blast_results/blastp_vigr_ev_motifs.blast")
```

```{r}
endia_motif_results <- endia_blastp_ev_motifs %>%
    left_join(endia_virscan_onset, by = join_by(qaccver == pep_id)) 

vigr_motif_results <- vigr_blastp_ev_motifs %>% 
   left_join(vigr_virscan_metadata, by = join_by(qaccver == pep_id))
```

### Examine BLAST results

```{r}
endia_motif_w_genera <- endia_motif_results %>%
  group_by(saccver, condition, taxon_genus) %>% 
  summarise(total_rpk = sum(rpk),
            no_of_peptides = n_distinct(qaccver),
            no_of_participants = n_distinct(participant_id),
            no_of_samples = n_distinct(sample_id),
            .groups = "drop")
```

```{r, fig.height=8}
endia_motif_w_genera %>%
  filter(taxon_genus == "Enterovirus") %>% 
  ggplot(aes(x = taxon_genus, y = total_rpk, fill = condition)) +
  geom_col(position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c("Case" = "#d73027", "Control" = "#4575b4"), labels = c("Case", "Control")) +
  geom_text(aes(label = no_of_peptides), 
            position = position_dodge(width = 0.9), 
            vjust = -0.2, hjust = -0.7, size = 3) +
  geom_text(aes(label = no_of_samples), 
            position = position_dodge(width = 0.9), 
            vjust = -2, hjust = -0.7, size = 3, color = "purple") +
  facet_wrap(~ saccver) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom",
        line = element_blank(),
      axis.text.x = element_blank(), 
      strip.text = element_text(face = "bold")) +
  labs(x = "Enterovirus peptides with significant hits", y = "Total normalised abundance", fill = "")
```

This essentially shows that the same peptides (black numbers) are present in all participants (purple number) between case and control
```{r, echo = FALSE, fig.height=8}
ggsave("figures/ev_hits_to_motifs.png", width = 8, height = 7)
```

### Stats

```{r}
endia_motif_for_stats <- endia_motif_results %>% 
  filter(taxon_genus == "Enterovirus") %>% 
  group_by(saccver, sample_id) %>% 
  mutate(total_rpk = sum(rpk)) %>% 
  mutate(total_abundance = sum(abundance)) %>% 
  ungroup() %>% 
  select(saccver, sample_id, case, condition, taxon_genus, total_rpk, infant_id, mother_id, 
         deidentified_nest_id_new, age_at_sample_collection_days, infant_sex,
         infant_HLA, weightTEDDY, maternal_T1D, total_abundance, log_lib) %>% 
  distinct(saccver, taxon_genus, sample_id, .keep_all = TRUE) %>% 
  mutate(age_sample_collection_month = age_at_sample_collection_days / 365 * 12) %>% 
  mutate(log_total_rpk = log(total_rpk + 1)) %>% 
  mutate(across(c(infant_HLA, maternal_T1D, infant_id, mother_id, deidentified_nest_id_new, infant_sex), as.factor)) %>% 
  mutate(age_c = scale(age_at_sample_collection_days)) %>% 
  mutate(total_rpk_int = as.integer(total_rpk)) %>%  # also testing
  mutate(Condition = factor(condition, levels = c("Control", "Case"), labels = c("Control", "Case"))) # for testing purposes
```

ENDIA 3D region 

```{r}
endia_3d_motif_for_stats <- endia_motif_for_stats %>% filter(saccver == "3D_motif")

endia_3d_model <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + infant_sex + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats)

endia_3d_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE)

summary(endia_3d_model)
```

slightly lower AIC for no_nest model 
*TODO: test other models to see if they are better without `(1|deidentified_nest_id_new)`*

```{r}
endia_3d_model_no_nest <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + infant_sex + maternal_T1D + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats)
  
endia_3d_model_no_nest %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE)

anova(endia_3d_model, endia_3d_model_no_nest)
```

3D stratified by sex 

No significance in abundances but HLA is significant in females 
```{r}
endia_3d_motif_for_stats_xy <- endia_3d_motif_for_stats %>% filter(infant_sex == "Male")
endia_3d_motif_for_stats_xx <- endia_3d_motif_for_stats %>% filter(infant_sex == "Female")

endia_3d_model_xy <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats_xy)

endia_3d_model_xx <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats_xx)

endia_3d_model_xx %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 

endia_3d_model_xy %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 
```

3d doesn't seem to be a good predictor, but enrichment of 3D in cases 

Trying with offset doesn't work well with case ~ total_abundance but is okay for total_abundance ~ case

```{r, eval = FALSE}
glmmTMB(formula = case ~ total_abundance + infant_HLA + age_sample_collection_month + infant_sex + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
        offset = log_lib,
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats)

glmmTMB(formula = total_abundance ~ Condition + infant_HLA + age_sample_collection_month + infant_sex + maternal_T1D + offset(log_lib) + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats)
```

### VP1 

```{r}
endia_vp1_motif_for_stats <- endia_motif_for_stats %>% filter(saccver == "VP1_motif")

endia_vp1_model <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + infant_sex + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_vp1_motif_for_stats)

endia_vp1_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 
```

Separate sexes 

```{r}
endia_vp1_motif_for_stats_xy <- endia_vp1_motif_for_stats %>% filter(infant_sex == "Male")
endia_vp1_motif_for_stats_xx <- endia_vp1_motif_for_stats %>% filter(infant_sex == "Female")


endia_vp1_xy_model <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + maternal_T1D +  (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_vp1_motif_for_stats_xy)

endia_vp1_xx_model <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_vp1_motif_for_stats_xx)

endia_vp1_xx_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 

endia_vp1_xy_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 

summary(endia_vp1_xy_model)
summary(endia_vp1_xx_model)
```


#### VIGR

```{r}
vigr_motif_for_stats <- vigr_motif_results %>% 
  mutate(Nest = str_extract(sample_id, "\\d+")) %>% 
  filter(taxon_genus == "Enterovirus") %>% 
  group_by(saccver, sample_id) %>% #removed condition
  mutate(total_rpk = sum(rpk)) %>% 
  ungroup() %>% 
  select(saccver, Condition, total_rpk, sample_id, taxon_genus, 
         Nest, Age, Sex, HLA_Status, My_name) %>% 
 distinct(saccver, taxon_genus, sample_id, .keep_all = TRUE) %>% 
 mutate(case = ifelse(Condition == "Case", 1, 0),
        log_total_rpk = log(total_rpk + 1),
        across(c(HLA_Status, Sex, Nest, My_name), as.factor))
```

VIGR 3D region

```{r}
vigr_3d_motif_for_stats <- vigr_motif_for_stats %>% filter(saccver == "3D_motif")

vigr_3d_model <- glmmTMB(formula = case ~ log_total_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name),
       family = poisson(link = "log"),
       data = vigr_3d_motif_for_stats)

vigr_3d_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 

```

VIGR VP1 region

```{r}
vigr_vp1_motif_for_stats <- vigr_motif_for_stats %>% filter(saccver == "VP1_motif")

vigr_vp1_model <- glmmTMB(formula = case ~ log_total_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name),
       family = poisson(link = "log"),
       data = vigr_vp1_motif_for_stats)

vigr_vp1_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 

vigr_vp1_motif_for_stats_xy <- vigr_vp1_motif_for_stats %>% filter(Sex == "M")
vigr_vp1_motif_for_stats_xx <- vigr_vp1_motif_for_stats %>% filter(Sex == "F")

# females 
vigr_vp1_xx_model <- glmmTMB(formula = case ~ log_total_rpk + HLA_Status + Age + (1|Nest) + (1|My_name),
       family = poisson(link = "log"),
       data = vigr_vp1_motif_for_stats_xx)

vigr_vp1_xx_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 

# males 

vigr_vp1_xy_model <- glmmTMB(formula = case ~ log_total_rpk + HLA_Status + Age + (1|Nest) + (1|My_name),
       family = poisson(link = "log"),
       data = vigr_vp1_motif_for_stats_xy)

vigr_vp1_xy_model %>% broom.mixed::tidy(conf.int = TRUE, exponentiate = TRUE) 
```

-----------------------------------------------------

### Snippets

Comparing ENDIA models with and without `maternal_T1D`

```{r}
# 3D 
endia_3d_model_no_mumt1d <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_3d_motif_for_stats)

anova(endia_3d_model, endia_3d_model_no_mumt1d)

# VP1 females

endia_vp1_model_no_mumt1d <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_vp1_motif_for_stats)

anova(endia_vp1_model,endia_vp1_model_no_mumt1d)

# VP1 males 
endia_vp1_xy_model_nomumt1d <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + (1|deidentified_nest_id_new) + (1|mother_id),
       family = poisson(link = "log"),
        weights = weightTEDDY,
       data = endia_vp1_motif_for_stats_xy)

anova(endia_vp1_xy_model, endia_vp1_xy_model_nomumt1d)

# VP1 females 

endia_vp1_xx_model_no_mumt1d <- glmmTMB(formula = case ~ log_total_rpk + infant_HLA + age_sample_collection_month + maternal_T1D + (1|deidentified_nest_id_new) + (1|mother_id),
        family = poisson(link = "log"),
        weight = weightTEDDY,
        data = endia_vp1_motif_for_stats_xx)

anova(endia_vp1_xx_model, endia_vp1_xx_model_no_mumt1d)
```

Looking at the other genera included in BLAST results

- remove genera with 0 abundance
- possible redo BLAST with only EV peptides (as other genera have low peptide count ( <5 ) and low abundance in comparison to EV genus and could contribute to noise in the model)

Figure showing all taxon genera 
```{r}
endia_motif_w_genera %>%
  ggplot(aes(x = taxon_genus, y = log(total_rpk + 1), fill = condition)) +
  geom_col(position = position_dodge(width = 0.9)) +
  geom_text(aes(label = no_of_peptides), 
            position = position_dodge(width = 0.9), 
            vjust = -0.2, hjust = -0.7, size = 3) +
  geom_text(aes(label = no_of_samples), 
            position = position_dodge(width = 0.9), 
            vjust = -2, hjust = -0.7, size = 3, color = "purple") +
 scale_fill_manual(values = c("Case" = "#d73027", "Control" = "#4575b4"), labels = c("Case", "Control")) +
  coord_flip() +
  facet_wrap(~ saccver) +
  theme_minimal() +
  theme(legend.position = "bottom") 

# these genera have 0 abundance in our onset samples
endia_motif_results %>% 
  group_by(taxon_genus) %>%
  summarise(total_rpk = sum(rpk)) %>% 
  filter(total_rpk == 0) %>% # filter genus that have 0 abundance
  pull(taxon_genus)
```

Trying with binomial model
*This has good results without the deidentified nest!*
```{r}
endia_3d_model_binomial <- glmmTMB(formula = Condition ~ log_total_rpk + infant_HLA + age_sample_collection_month + infant_sex + maternal_T1D + (1|mother_id) ,
       family = binomial(link = "logit"),
       weights = weightTEDDY,
       data = endia_3d_motif_for_stats) 

summary(endia_3d_model_binomial)

test <- glmmTMB(formula = Condition ~ total_abundance + infant_HLA + age_sample_collection_month + infant_sex + offset(log_lib) + maternal_T1D + (1|mother_id) ,
       family = binomial(link = "logit"),
       weights = weightTEDDY,
       data = endia_3d_motif_for_stats) 

summary(test)

```
