---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, options(readr.show_col_types = FALSE))
```

```{r}
library(tidyverse)
library(ampir)
library(patchwork)
library(lme4)
library(broom.mixed)
```

*TODO:* 

- move functions to scripts
- combine fit_glm function for VIGR and ENDIA into a single function
- Try negative binomial model (with potential zero inflation) for ENDIA
- Tidy up :broom:
- attend other TODO notes spread in this Rmd

- Examine how changing Random Effects affect the models

- Possibly re-run everything with ENDIA controls removed that were once cases:

- VIC_MEL_RMH_057_V4 in nest 1985 
- NSW_SYD_STG_007_V5 in nest 3941

```{r}
endia_virscan_onset <- read_rds("cache/endia_virscan_metadata.rds") %>% 
  filter(onset_visit == 1) %>% 
  group_by(sample_id) %>% 
  mutate(rpk = abundance / sum(abundance) * 100000) %>% 
  ungroup()

vigr_virscan_metadata <- read_rds("cache/vigr_virscan_metadata.rds") %>% 
  mutate(Nest = str_extract(sample_id, "\\d+")) %>% 
  group_by(sample_id) %>% 
  mutate(rpk = abundance / sum(abundance) * 100000) %>% 
  ungroup()
```

### ENDIA

Quick plot to show the abundance in cases and controls for all genera

```{r, fig.width=8, fig.height=8}
endia_virscan_onset %>%
  group_by(taxon_genus, condition) %>%
  summarise(total_rpk = sum(rpk, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = taxon_genus, y = total_rpk, fill = condition), alpha = 0.5) +
  coord_flip() +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("Case" = "#d73027", "Control" = "#4575b4"), labels = c("Case", "Control")) +
  labs(x = "Genus", y = "Total abundance per genus") +
  theme_classic()
```

### Statistical comparison of the abundance of multiple genera between case and control

Get top most abundant genera in cases and controls

```{r}
endia_top_genera_in_both_conditions <- endia_virscan_onset %>%
  group_by(condition, taxon_genus) %>%
  summarise(genus_rpk = sum(rpk, na.rm = TRUE), .groups = "drop") %>%
  group_by(condition) %>%
  slice_max(genus_rpk, n = 30) %>%  # get top 30 abundant genera per condition
  ungroup() %>%
  semi_join(            # keep only genera that appear in both conditions' top 30
    count(., taxon_genus) %>% filter(n == 2), 
    by = "taxon_genus"
  ) %>%
  group_by(taxon_genus) %>%
  mutate(total_rpk_overall = sum(genus_rpk)) %>% # get total abundance for both conditions combined per genus
  ungroup() %>%
  arrange(desc(total_rpk_overall), taxon_genus, condition) # arrange so top most abundant genera are first
```

```{r}
endia_top_genera_in_both_conditions
```

Extract the VirScan data for the most abundant genera 
```{r}
endia_top_genera <- endia_top_genera_in_both_conditions %>% pull(taxon_genus) %>% unique()

endia_top_genera_onset <- endia_virscan_onset %>% 
  group_by(sample_id, taxon_genus) %>% 
  mutate(genus_rpk = sum(rpk)) %>% 
  ungroup() %>% 
  distinct(taxon_genus, sample_id, .keep_all = TRUE) %>% 
  select(sample_id, case, condition, taxon_genus, genus_rpk, infant_id, mother_id, 
         deidentified_nest_id_new, age_at_sample_collection_days, infant_sex,
         infant_HLA, weightTEDDY) %>% 
 mutate(age_sample_collection_month = age_at_sample_collection_days / 365 * 12) %>% 
 filter(taxon_genus %in% endia_top_genera) # filter to only include top genera
```

```{r}
# Function to fit a GLM model for a single genus 
run_glms_on_genera_endia <- function(df) {
  
  unique_genera <- df %>% pull(taxon_genus) %>% unique()
  
   map(set_names(unique_genera), function(genus) {
    single_genus_data <- df %>% filter(taxon_genus == genus)
    
    glmer(
      formula = case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|deidentified_nest_id_new) + (1|mother_id),
      data = single_genus_data,
      family = poisson(link = "log"),
      weights = weightTEDDY,
      control = glmerControl(optimizer = "nloptwrap", optCtrl = list(maxfun = 2e5))
    )
  })
}

# Function to extract and tidy GLM results

tidy_glm_results <- function(glm_list) {
  tidy_glm_results_list <- map(names(glm_list), function(genus) {
    broom.mixed::tidy(glm_list[[genus]], effects = "fixed", conf.int = TRUE, exponentiate = TRUE) %>%
      filter(term == "log_genus_rpk") %>%
      mutate(genus = genus, .before = effect) %>% 
      rename(risk_ratio = estimate,
         ci_low = conf.low,
         ci_high = conf.high)
  })
  
  # combine results into a single dataframe and apply multiple testing correction
  list_rbind(tidy_glm_results_list) %>%
    mutate(p_adjust_BH = p.adjust(p.value, method = "BH")) 
}
```


Test on enterovirus and mastadenovirus, works ok. 
```{r}
top_genera <- c("Enterovirus", "Mastadenovirus")

endia_top_genera_onset_log_rpk <- endia_top_genera_onset %>% 
    mutate(log_genus_rpk = log(genus_rpk + 1)) %>% 
    mutate(across(c(infant_HLA, infant_id, mother_id, deidentified_nest_id_new, infant_sex), as.factor)) %>% 
  filter(taxon_genus %in% top_genera)

endia_genera_glms <- run_glms_on_genera_endia(endia_top_genera_onset_log_rpk)

tidy_glm_results(endia_genera_glms)
```



Using all top genera

```{r}
endia_all_top_genera_onset_log_rpk <- endia_top_genera_onset %>% 
    mutate(log_genus_rpk = log(genus_rpk + 1)) %>% 
    mutate(across(c(infant_HLA, infant_id, mother_id, deidentified_nest_id_new, infant_sex), as.factor))
```

Plot to show distribution of values (log transformed for GLM)

```{r, fig.width=8, fig.height=8}
endia_all_top_genera_onset_log_rpk %>%
  ggplot(aes(x = log_genus_rpk, colour = condition), alpha = 0.5) +
  geom_density() +
  scale_colour_manual(values = c("Case" = "#d73027", "Control" = "#4575b4"), labels = c("Case", "Control")) +
  labs(x = "log_genus_rpk", y = "Density") +
  theme_classic() +
  facet_wrap(~taxon_genus)
```

*TODO:* 3 models failed to converge so must fix that.
*TODO:* perhaps add column with the warnings in output for each genus

```{r}
endia_top_genera_glms <- run_glms_on_genera_endia(endia_all_top_genera_onset_log_rpk)

endia_top_genera_glms_tidy <- tidy_glm_results(endia_top_genera_glms)

endia_top_genera_glms_tidy
```


```{r}
endia_top_genera_glms_tidy %>% 
  mutate(genus_w_pvalue = paste(genus, "(",round(p_adjust_BH, digits = 2),")")) %>% 
  arrange(desc(risk_ratio)) %>% 
  mutate(genus_w_pvalue = factor(genus_w_pvalue, levels = rev(unique(genus_w_pvalue)))) %>% 
  ggplot(aes(x = risk_ratio, y = genus_w_pvalue)) +
  geom_point(color = "black") +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.2, color = "black") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Reference line
  theme_minimal() +
  labs(x = "Risk Ratio", y = "Genus and adjusted BH P value") +
  theme(axis.text.y = element_text(size = 10, face = "italic")) 

```

RR > 1 = increased risk
RR < 1 = decreased risk
RR = 1 = no effect (H0)

### VIGR

```{r}
vigr_top_genera_in_both_conditions <- vigr_virscan_metadata %>% 
  group_by(Condition, taxon_genus) %>%
  summarise(genus_rpk = sum(rpk, na.rm = TRUE), .groups = "drop") %>%
  group_by(Condition) %>%
  slice_max(genus_rpk, n = 30) %>%  # get top 30 abundant genera per condition
  ungroup() %>%
  semi_join(            # keep only genera that appear in both conditions' top 30
    count(., taxon_genus) %>% filter(n == 2), 
    by = "taxon_genus"
  ) %>%
  group_by(taxon_genus) %>%
  mutate(total_rpk_overall = sum(genus_rpk)) %>% # get total abundance for both conditions combined per genus
  ungroup() %>%
  arrange(desc(total_rpk_overall), taxon_genus, Condition) %>% # arrange so top most abundant genera are first
  filter(!is.na(taxon_genus)) #remove abundant NA taxon_genus

vigr_top_genera <- vigr_top_genera_in_both_conditions %>% pull(taxon_genus) %>% unique()

vigr_top_genera_virscan_log_rpk <- vigr_virscan_metadata %>% 
  group_by(sample_id, taxon_genus) %>% 
  mutate(genus_rpk = sum(rpk)) %>% 
  ungroup() %>% 
  distinct(taxon_genus, sample_id, .keep_all = TRUE) %>% 
  select(Condition, genus_rpk, sample_id, taxon_genus, 
         Nest, Age, Sex, HLA_Status, My_name) %>% 
 filter(taxon_genus %in% vigr_top_genera) %>%  # filter to only include top genera
 mutate(case = ifelse(Condition == "Case", 1, 0),
        log_genus_rpk = log(genus_rpk + 1),
        across(c(HLA_Status, Sex, Nest, My_name), as.factor))
```

Crazy spike for enterovirus again at high `log_rpk`

```{r, fig.width=8, fig.height=8}
vigr_top_genera_virscan_log_rpk %>%
  ggplot(aes(x = log_genus_rpk, colour = Condition), alpha = 0.5) +
  geom_density() +
  scale_colour_manual(values = c("Case" = "#d73027", "Control" = "#4575b4"), labels = c("Case", "Control")) +
  labs(x = "log_genus_rpk", y = "Density") +
  theme_classic() +
  facet_wrap(~taxon_genus)
```

```{r}
run_glms_on_genera_vigr <- function(df) {
  
  unique_genera <- df %>% pull(taxon_genus) %>% unique()
  
   map(set_names(unique_genera), function(genus) {
    single_genus_data <- df %>% filter(taxon_genus == genus)
    
    glmer(
      formula = case ~ log_genus_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name),
      data = single_genus_data,
      family = poisson(link = "log"),
      control = glmerControl(optimizer = "nloptwrap", optCtrl = list(maxfun = 2e5))
    )
  })
}

vigr_top_genera_glms <- run_glms_on_genera_vigr(vigr_top_genera_virscan_log_rpk)

vigr_top_genera_glms_tidy <- tidy_glm_results(vigr_top_genera_glms)

vigr_top_genera_glms_tidy
```

Really wide CI for enterovirus?
*TODO: check for sample outliers*

```{r}
vigr_top_genera_glms_tidy %>% 
  mutate(genus_w_pvalue = paste(genus, "(",round(p_adjust_BH, digits = 2),")")) %>% 
  arrange(desc(risk_ratio)) %>% 
  mutate(genus_w_pvalue = factor(genus_w_pvalue, levels = rev(unique(genus_w_pvalue)))) %>% 
  ggplot(aes(x = risk_ratio, y = genus_w_pvalue)) +
  geom_point(color = "black") +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.2, color = "black") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Reference line
  theme_minimal() +
  labs(x = "Risk Ratio", y = "Genus and adjusted BH P value") +
  theme(axis.text.y = element_text(size = 10, face = "italic")) 
```

Testing binomial and poisson for VIGR. Interesting the AIC is lower for Binomial but the confidence intervals are a lot wider for Binomial. Also, speaking of which, the CI for the Intercept in both models is huge

```{r}
ev_virscan_genus_rpk <- vigr_top_genera_virscan_log_rpk %>% filter(taxon_genus == "Enterovirus")

vigr_model_binomial <- glmer(case ~ log_genus_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name), data = ev_virscan_genus_rpk, family = binomial(link = "logit"), control = glmerControl(optimizer = "nloptwrap", optCtrl = list(maxfun = 2e5)))

vigr_model_poisson <- glmer(formula = case ~ log_genus_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name), data = ev_virscan_genus_rpk,
      family = poisson(link = "log"),
      control = glmerControl(optimizer = "nloptwrap", optCtrl = list(maxfun = 2e5)))

vigr_model_binomial %>% tidy(conf.int = TRUE, exponentiate = TRUE)
vigr_model_poisson %>% tidy(conf.int = TRUE, exponentiate = TRUE)

AIC(vigr_model_binomial, vigr_model_poisson)
```

:construction:  :construction:  :construction: 

trying with neg. binom, no better in VIGR (*TODO*: try with ENDIA)
Maybe add dispersion variable with `dispformula` ? 

```{r}
library(glmmTMB)

vigr_model_neg_binom <- glmmTMB(case ~ log_genus_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name),
                                family = "nbinom2",
                                data = ev_virscan_genus_rpk)

vigr_model_neg_binom %>% tidy(conf.int = TRUE, exponentiate = TRUE)

AIC(vigr_model_neg_binom, vigr_model_binomial, vigr_model_poisson)

# convergence problem if adding zero convergence
vigr_model_neg_binom_zi <- glmmTMB(case ~ log_genus_rpk + HLA_Status + Age + Sex + (1|Nest) + (1|My_name),
                                   family = "nbinom2",
                                   data = ev_virscan_genus_rpk,
                                   ziformula = ~1)
```

#### Examining how changing Random Effects affect the model on enterovirus genus by using:

- both `deidentified_nest_id_new` and `mother_id`
- only `deidentified_nest_id_new`
- only `mother_id` *this option resulted in the lowest AIC and df*

```{r}
endia_onset_log_genus_rpk <- endia_virscan_onset %>% 
  group_by(sample_id, taxon_genus) %>% 
  mutate(genus_rpk = sum(rpk)) %>% 
  ungroup() %>% 
  distinct(taxon_genus, sample_id, .keep_all = TRUE) %>% 
  select(sample_id, case, condition, taxon_genus, genus_rpk, infant_id, mother_id, 
         deidentified_nest_id_new, age_at_sample_collection_days, infant_sex,
         infant_HLA, weightTEDDY) %>% 
  mutate(age_sample_collection_month = age_at_sample_collection_days / 365 * 12) %>% 
  mutate(log_genus_rpk = log(genus_rpk + 1)) %>% 
  mutate(across(c(infant_HLA, infant_id, mother_id, deidentified_nest_id_new, infant_sex), as.factor))

virscan_EV_onset <- endia_onset_log_genus_rpk %>% filter(taxon_genus == "Enterovirus") 

library(glmmTMB)

test_EV_virscan_glmm <- glmmTMB(
      formula = case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|deidentified_nest_id_new) + (1|mother_id),
      data = virscan_EV_onset,
      family = poisson(link = "log"),
      weights = weightTEDDY)

test_EV_virscan_glmm_no_mum_id <- glmmTMB(
      formula = case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|deidentified_nest_id_new),
      data = virscan_EV_onset,
      family = poisson(link = "log"),
      weights = weightTEDDY)

test_EV_virscan_glmm_no_nest <- glmmTMB(
      formula = case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|mother_id),
      data = virscan_EV_onset,
      family = poisson(link = "log"),
      weights = weightTEDDY)

summary(test_EV_virscan_glmm_no_nest)
test_EV_virscan_glmm_no_nest %>% broom::tidy()

anova(test_EV_virscan_glmm, test_EV_virscan_glmm_no_mum_id, test_EV_virscan_glmm_no_nest)
```

-------------------------------------------------------------------------------

## Basic descriptive stats for total antibody response per genus in both cohorts :white_check_mark:

Get most total number of peptides per genus and percentage of the total

**VIGR**

```{r}
vigr_virscan_metadata %>% 
  group_by(taxon_genus, Condition) %>%
  summarise(total_abundance = sum(abundance)) %>%
  ungroup() %>% 
  mutate(percentage = total_abundance / sum(total_abundance) * 100) %>% 
  ungroup() %>% 
  arrange(desc(percentage)) %>% 
  mutate(percentage = as.integer(percentage))
```

**ENDIA**

```{r}
endia_virscan_onset %>% 
   group_by(taxon_genus, condition) %>%
  summarise(total_abundance = sum(abundance)) %>%
  ungroup() %>% 
  mutate(percentage = total_abundance / sum(total_abundance) * 100) %>% 
  ungroup() %>% 
  arrange(desc(percentage)) %>% 
  mutate(percentage = as.integer(percentage))
```

Get minimum and maximum abundance values across samples for the *Enterovirus* genus 

**VIGR**

```{r}
vigr_virscan_metadata %>% 
  group_by(sample_id) %>% 
  mutate(total_peps = sum(abundance)) %>% 
  filter(taxon_genus == "Enterovirus") %>%
  mutate(no_peps = sum(abundance) / total_peps * 100) %>%
  ungroup() %>% 
  group_by(Condition) %>% 
  summarise(
    max_value = max(no_peps), 
    min_value = min(no_peps)
  ) %>% 
  ungroup()
```

**ENDIA**

```{r}
endia_virscan_onset %>% 
    group_by(sample_id) %>% 
  mutate(total_peps = sum(abundance)) %>% 
  filter(taxon_genus == "Enterovirus") %>%
  mutate(no_peps = sum(abundance) / total_peps * 100) %>%
  ungroup() %>% 
  group_by(condition) %>% 
  summarise(
    max_value = max(no_peps), 
    min_value = min(no_peps)
  ) %>% 
  ungroup()
```

Check ages in samples with lowest and highest peptide percentage 

**VIGR**

```{r}
vigr_virscan_metadata %>% 
  group_by(sample_id) %>% 
  mutate(total_peps = sum(abundance)) %>% 
  filter(taxon_genus == "Enterovirus") %>%
  mutate(no_peps = sum(abundance) / total_peps * 100) %>%
  ungroup() %>% 
  filter(no_peps < 30 | no_peps > 75) %>% 
  select(sample_id, Condition, Age, no_peps) %>% 
  distinct(sample_id, .keep_all = TRUE) %>% 
  arrange(no_peps)
```

**ENDIA**

```{r}
endia_virscan_onset %>% 
  group_by(sample_id) %>% 
  mutate(total_peps = sum(abundance)) %>% 
  filter(taxon_genus == "Enterovirus") %>%
  mutate(no_peps = sum(abundance) / total_peps * 100) %>%
  ungroup() %>% 
  filter(no_peps == 0 | no_peps > 95) %>% 
  mutate(age_years = age_at_sample_collection_days / 365) %>% 
  select(sample_id, condition, age_years, no_peps) %>% 
  distinct(sample_id, .keep_all = TRUE) %>% 
  arrange(no_peps)
```


## Snippets :scissors:

<details>
  <summary><i>Comparing top abundant vs top normalised abundant (rpk) </i></summary>
  
Comparing top abundant vs top normalised abundant (rpk) 

```{r}
endia_top_rpk_in_both_conditions <- endia_virscan_onset %>%
  group_by(taxon_genus, condition) %>%
  summarise(total_rpk = sum(rpk, na.rm = TRUE), .groups = "drop") %>%
  group_by(condition) %>%
  slice_max(total_rpk, n = 30) %>%  # get top 30 abundant genera per condition
  ungroup() %>%
  semi_join(            # keep only genera that appear in both conditions' top 30
    count(., taxon_genus) %>% filter(n == 2), 
    by = "taxon_genus"
  ) %>%
  group_by(taxon_genus) %>%
  mutate(total_rpk_overall = sum(total_rpk)) %>% # get total abundance for both conditions combined per genus
  ungroup() %>%
  arrange(desc(total_rpk_overall), taxon_genus, condition) #%>% # arrange so top most abundant genera are first

endia_top_abundant_in_both_conditions <- endia_virscan_onset %>%
  group_by(taxon_genus, condition) %>%
  summarise(total_abundance = sum(abundance, na.rm = TRUE), .groups = "drop") %>%
  group_by(condition) %>%
  slice_max(total_abundance, n = 30) %>%  # get top 30 abundant genera per condition
  ungroup() %>%
  semi_join(            # keep only genera that appear in both conditions' top 30
    count(., taxon_genus) %>% filter(n == 2), 
    by = "taxon_genus"
  ) %>%
  group_by(taxon_genus) %>%
  mutate(total_abundance_overall = sum(total_abundance)) %>% # get total abundance for both conditions combined per genus
  ungroup() %>%
  arrange(desc(total_abundance_overall), taxon_genus, condition) #%>% # arrange so top most abundant genera are first

setdiff(endia_top_rpk_in_both_conditions$taxon_genus, endia_top_abundant_in_both_conditions$taxon_genus )
```


</details>


<details>
  <summary><i> Alternative way of adding p values </i></summary>
  

```{r, fig.width=10}
vigr_top_genera_glms_tidy %>% 
  arrange(desc(risk_ratio)) %>% 
  mutate(genus_w_pvalue = factor(genus, levels = rev(unique(genus)))) %>% 
  ggplot(aes(x = risk_ratio, y = genus)) +
  geom_point(color = "black") +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.2, color = "black") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Reference line
  theme_minimal() +
  labs(x = "Risk Ratio", y = "Genus") +
  theme(axis.text.y = element_text(size = 10)) +
  annotate("text", x = min(vigr_top_genera_glms_tidy$risk_ratio) - 0.4, y = vigr_top_genera_glms_tidy$genus, 
           label = paste0("(", round(vigr_top_genera_glms_tidy$p_adjust_BH, 3), ")"), 
           hjust = 1, fontface = "italic", size = 3)  # Adjust size manually
```

</details>


<details>
  <summary><i> Export present genera in both cohorts plus their abundance to a table </i></summary>


```{r}
endia_genera_present_plus_rpk <- endia_virscan_onset %>%
  group_by(condition, taxon_genus) %>%
  summarise(genus_rpk = sum(rpk, na.rm = TRUE), .groups = "drop") %>%
  group_by(taxon_genus) %>%
  mutate(total_rpk_overall = sum(genus_rpk)) %>% # get total abundance for both conditions combined per genus
  ungroup() %>%
  arrange(desc(total_rpk_overall), taxon_genus, condition) %>%  # arrange so top most abundant genera are first
  add_column(cohort = "ENDIA")

vigr_genera_present_plus_rpk <- vigr_virscan_metadata %>% 
  group_by(Condition, taxon_genus) %>%
  summarise(genus_rpk = sum(rpk, na.rm = TRUE), .groups = "drop") %>%
  group_by(taxon_genus) %>%
  mutate(total_rpk_overall = sum(genus_rpk)) %>% # get total abundance for both conditions combined per genus
  ungroup() %>%
  arrange(desc(total_rpk_overall), taxon_genus, Condition) %>% # arrange so top most abundant genera are first
  add_column(cohort = "VIGR")


write_tsv(endia_genera_present_plus_rpk, "cache/endia_genera_plus_rpk.tsv")
write_tsv(vigr_genera_present_plus_rpk, "cache/vigr_genera_plus_rpk.tsv")

# sanity check
endia_genera_present_plus_rpk %>% pull(taxon_genus) %>% unique() %>% length()
vigr_genera_present_plus_rpk  %>% pull(taxon_genus) %>% unique() %>% length()

vigr_virscan_metadata %>% filter(!is.na(taxon_genus)) %>%  pull(taxon_genus) %>% unique() %>% length()
endia_virscan_onset %>% filter(!is.na(taxon_genus)) %>% pull(taxon_genus) %>% unique() %>% length()
```

</details>

<details>
  <summary><i> Try with conditional logistic regression </i></summary>
  
Try with conditional logistic regression. Standard `clogit` does not support mixed effects, so I had to remove `mother_id` and only use the Nest as strata.

```{r}
endia_ev_data <- endia_top_genera_onset %>% 
    mutate(log_genus_rpk = log(genus_rpk + 1)) %>% 
    mutate(across(c(infant_HLA, infant_id, mother_id, deidentified_nest_id_new, infant_sex), as.factor)) %>% 
  filter(taxon_genus == "Enterovirus")


library(survival)

endia_clogit_model <- clogit(
  case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + strata(deidentified_nest_id_new),
  data = endia_ev_data,
  weights = weightTEDDY,
  method = "approximate" # need to do this instead of "exact" due to the added weights
)

endia_clogit_model
```

Try with different package that supports mixed effects
*Note this doesn't work, syntax is off*
*TODO: Fix*

```{r, eval = FALSE}
library(mclogit)

mclogit(
  formula = ~ case + log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex,
  random = (1 | deidentified_nest_id_new),
  data = endia_ev_data,
  weights = weightTEDDY)
```

</details>

:construction:

#### Trying different families for EV genus

All families are `link = "log"` except for Binomial which is `link = "logit"`

- Poisson 
- Poisson (zero inflated)
- Binomial(link = "logit")
- Negative binomial1
- Negative binomial2 
- Negative binomial2 (zero inflated)

`nbinom2` is resulting in `NAN` values for all parameters except for `estimate` ?


```{r}
endia_form <- as.formula("case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1|deidentified_nest_id_new) + (1|mother_id)")

endia_ev_data <- endia_top_genera_onset %>% 
    mutate(log_genus_rpk = log(genus_rpk + 1)) %>% 
    mutate(across(c(infant_HLA, infant_id, mother_id, deidentified_nest_id_new, infant_sex), as.factor)) %>% 
  filter(taxon_genus == "Enterovirus")

library(glmmTMB)


endia_model_poisson <- glmmTMB(
  case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1 | deidentified_nest_id_new) + (1 | mother_id),
  data = endia_ev_data,
  family = poisson(link = "log"),
  weights = weightTEDDY
)

endia_model_poisson_zero <- glmmTMB(
  case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1 | deidentified_nest_id_new) + (1 | mother_id),
  data = endia_ev_data,
  z = ~1,
  family = poisson(link = "log"),
  weights = weightTEDDY
)

endia_model_binom <- glmmTMB(
  case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1 | deidentified_nest_id_new) + (1 | mother_id),
  data = endia_ev_data,
  family = binomial(link = "logit"),
  weights = weightTEDDY
)

endia_model_nbinom1 <- glmmTMB(
  case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1 | deidentified_nest_id_new) + (1 | mother_id),
  data = endia_ev_data,
  family = nbinom1(link = "log"),
  weights = weightTEDDY, 
  control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS"))
)

endia_model_nbinom_zero <- glmmTMB(
  case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1 | deidentified_nest_id_new) + (1 | mother_id),
  data = endia_ev_data,
  family = nbinom2(link = "log"),
  z = ~1,
  weights = weightTEDDY, 
  control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS"))
)

AIC(endia_model_poisson, endia_model_poisson_zero, endia_model_binom, endia_model_nbinom1, endia_model_nbinom_zero)
```


```{r}
tidy_glm_output <- function(glm_model, family_name) {
  broom.mixed::tidy(glm_model, effects = "fixed", conf.int = TRUE, exponentiate = TRUE) %>%
      filter(term == "log_genus_rpk") %>%
      mutate(model_family = family_name, .before = effect) %>% 
      rename(exp_coefficient = estimate,
         ci_low = conf.low,
         ci_high = conf.high)
}

endia_model_poisson_tidy <- endia_model_poisson %>% tidy_glm_output("Poisson")
endia_model_poisson_zero_tidy <- endia_model_poisson_zero %>% tidy_glm_output("Poisson Zero infl.")
endia_model_binom_tidy <- endia_model_binom %>% tidy_glm_output("Binomial (logit)")
endia_model_nbinom1_tidy <- endia_model_nbinom1 %>% tidy_glm_output("Neg. binomial")
endia_model_nbinom_zero_tidy <- endia_model_nbinom_zero %>% tidy_glm_output("Neg. binomial Zero infl.")

results <- bind_rows(endia_model_poisson_tidy, endia_model_poisson_zero_tidy, endia_model_binom_tidy, endia_model_nbinom1_tidy, endia_model_nbinom_zero_tidy)

results %>% 
  mutate(model_family_w_pvalue = paste(model_family, "(",round(p.value, digits = 2),")")) %>% 
  arrange(desc(exp_coefficient)) %>% 
  mutate(model_family_w_pvalue = factor(model_family_w_pvalue, levels = rev(unique(model_family_w_pvalue)))) %>% 
  ggplot(aes(x = exp_coefficient, y = model_family_w_pvalue)) +
  geom_point(color = "black") +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.2, color = "black") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Reference line
  theme_minimal() +
  labs(x = "Exponential of coefficient", y = "Model familt and P value") +
  theme(axis.text.y = element_text(size = 10, face = "italic")) 
```

### Try with bayesian approach 

Using the Markov Chain Monte Carlo method compared to maximum likelihood from the other GLM packages

*TODO:*

- double check both glmmTMB and lme4 use frequentist / max. likelihood approach
- try the [spAbundance R package](https://doserlab.com/files/spabundance-web/articles/glmm)
- look into this `brms` result and what it means
- compare different distributions (neg. binom and poisson)

:question: *are family distributions the same for frequentist/bayesian approaches? e.g would poisson/neg binom still be the way to go, or would gaussian be ok now?*


```{r}
library(brms)

ev_bay_negbinom_mod <- brm(formula = case ~ log_genus_rpk + infant_HLA + age_sample_collection_month + infant_sex + (1 | deidentified_nest_id_new) + (1 | mother_id),
    data = endia_ev_data,
    family = negbinomial())
```
